<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biorhythm Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .active-nav-button {
            background-color: #345388; /* A darker blue to indicate selection */
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.25);
        }
        /* CSS to create an orange triangle pointing up */
        .biorhythm-crit-marker {
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 18px solid #f97316; /* Orange color */
            transition: opacity 0.2s;
        }
        /* Adds a thin black outline for the markers on the Colors page */
        .biorhythm-crit-marker.black-outlined-marker {
            filter: drop-shadow(0 0 1px black);
        }
        /* Adds a thin white outline for the marker in the key */
        .biorhythm-crit-marker.white-outlined-marker {
            filter: drop-shadow(0 0 1px white);
        }

        /* Responsive styles for the calendar */
        .days-grid-responsive {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.25rem;
        }
        
        @media (max-width: 767px) {
            .weekdays-header {
                display: none; /* Hide the weekday header on small screens */
            }
            .days-grid-responsive {
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: 100%;
            }
            .day-cell-responsive {
                min-height: auto;
                height: 5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .day-number-responsive {
                position: static;
                font-size: 1.5rem;
            }
            .day-labels-responsive {
                position: static;
                transform: none;
                flex-grow: 1;
                justify-content: flex-end;
            }
            .crit-marker-container-responsive {
                position: static;
                justify-content: flex-end;
                padding: 0;
                margin-left: 1rem;
            }
        }
    </style>
</head>
<body class="bg-[#0d172a] flex flex-col min-h-screen text-gray-200">

    <!-- Sticky Top Header Container -->
    <div id="controls-container" class="sticky top-0 z-50 bg-[#132238] shadow-lg px-4 py-3 flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0 md:space-x-4">
        
        <!-- Birthday Picker -->
        <div id="birthday-picker-container" class="flex flex-col items-center space-y-2 text-lg md:text-xl">
            <div id="current-subject-display" class="font-bold text-2xl mb-2"></div>
        </div>

        <!-- Month/Year selectors for Colors/Bars page -->
        <div id="month-year-selectors" class="flex items-center space-x-2 hidden">
            <button id="prev-month-btn" class="bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-full text-base md:text-xl">&lt;</button>
            <select id="month-select" class="bg-[#2a4365] text-white rounded-md p-1 md:p-2 text-base md:text-xl"></select>
            <select id="year-select" class="bg-[#2a4365] text-white rounded-md p-1 md:p-2 text-base md:text-xl"></select>
            <button id="next-month-btn" class="bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-full text-base md:text-xl">&gt;</button>
        </div>

        <!-- Week Start Toggle for Colors/Bars page -->
        <button id="week-start-toggle" class="bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-md transition-colors duration-200 text-base md:text-lg hidden">
            Begin week on Monday
        </button>
    </div>
    
    <!-- Main container for the pages -->
    <main class="flex-1 flex flex-row items-start px-4 sm:px-8 lg:px-12 pb-24">
        <!-- Navigation Menu to switch between pages -->
        <nav class="flex flex-col space-y-4 pr-4 pt-16">
            <button id="nav-colors" class="nav-button bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-md transition-colors duration-200 text-base md:text-lg">
                Colors
            </button>
            <button id="nav-bars" class="nav-button bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-md transition-colors duration-200 text-base md:text-lg">
                Bars
            </button>
            <button id="nav-today" class="nav-button bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-md transition-colors duration-200 text-base md:text-lg">
                Today
            </button>
            <button id="nav-friends" class="nav-button bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-md transition-colors duration-200 text-base md:text-lg">
                Friends
            </button>
            <button id="nav-help" class="nav-button bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-md transition-colors duration-200 text-base md:text-lg">
                Help
            </button>
            <!-- Label for Critical Days -->
            <div id="critical-day-label" class="flex flex-col items-center mt-4">
                <div class="biorhythm-crit-marker white-outlined-marker mb-1"></div>
                <span class="text-xs text-white">Critical Day</span>
            </div>
        </nav>
    
        <div class="w-full flex flex-col rounded-lg flex-1">
            <!-- Calendar Container for Colors and Bars pages -->
            <div id="calendar-container" class="page-content hidden w-full p-4 sm:p-6 bg-[#132238] rounded-lg flex flex-col mb-0 flex-1">
                <div class="weekdays-header grid grid-cols-7 gap-1 text-center font-bold text-lg text-white"></div>
                <div class="days-grid grid grid-cols-7 gap-1 mt-2 flex-1"></div>
            </div>

            <!-- Page 3 Content (Today) -->
            <div id="page3-content" class="page-content hidden w-full flex-col flex-1 p-4 sm:p-6 bg-[#132238] rounded-lg">
                <!-- Today Date Picker -->
                <div class="flex flex-col items-center mb-6">
                    <label class="text-lg md:text-xl font-bold mb-2">Biorhythm for:</label>
                    <div id="today-date-picker" class="flex items-center space-x-2 justify-center">
                        <button id="prev-day-btn" class="bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-full text-base md:text-xl">&lt;</button>
                        <select id="today-month-select" class="bg-[#2a4365] text-white rounded-md p-1 md:p-2 text-lg md:text-xl"></select>
                        <select id="today-day-select" class="bg-[#2a4365] text-white rounded-md p-1 md:p-2 text-lg md:text-xl"></select>
                        <select id="today-year-select" class="bg-[#2a4365] text-white rounded-md p-1 md:p-2 text-lg md:text-xl"></select>
                        <button id="next-day-btn" class="bg-[#2a4365] hover:bg-[#345388] text-white font-bold py-1 px-3 md:py-2 md:px-4 rounded-full text-base md:text-xl">&gt;</button>
                    </div>
                    <span id="today-date-text" class="text-xl md:text-2xl font-bold mt-2"></span>
                </div>
                <div id="today-display-grid" class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 flex-1"></div>
            </div>

            <!-- Page 5 Content (Friends) -->
            <div id="page5-content" class="page-content hidden w-full flex-col flex-1 p-4 sm:p-6 bg-[#132238] rounded-lg">
                <h1 class="text-3xl sm:text-4xl font-bold mb-4">Your Friends</h1>
                <p id="loading-friends" class="text-center text-lg mt-4">Loading friends data...</p>
                <div id="friends-list" class="space-y-2 mb-6"></div>
                <form id="add-friend-form" class="mt-4 flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-4">
                    <input type="text" id="friend-name" placeholder="Friend's Name" required class="flex-1 bg-[#2a4365] text-white rounded-md p-2">
                    <div class="flex-1 flex space-x-2">
                        <select id="friend-month-select" class="flex-1 bg-[#2a4365] text-white rounded-md p-2"></select>
                        <select id="friend-day-select" class="flex-1 bg-[#2a4365] text-white rounded-md p-2"></select>
                        <select id="friend-year-select" class="flex-1 bg-[#2a4365] text-white rounded-md p-2"></select>
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                        Add Friend
                    </button>
                    <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                        Cancel Edit
                    </button>
                </form>
            </div>
            
            <!-- Page 4 Content (Help) -->
            <div id="page4-content" class="page-content hidden flex-col flex-1 p-4 sm:p-6 bg-[#132238] rounded-lg">
                <h1 class="text-3xl sm:text-4xl font-bold mb-4">What Are Biorhythms?</h1>
                <p class="text-lg mb-6 leading-relaxed">
                    Biorhythms are the three cycles that control human performance from birth: a 28-day emotional cycle (Red), a 23-day physical cycle (Green), and a 33-day intellectual cycle (Blue). These cycles create “good” and “bad” days for mood, strength, and mental abilities. Days when a cycle crosses the midpoint (Orange triangle) are "critical." Performance on a critical day may be unreliable.
                </p>
                <p class="text-lg mb-6 leading-relaxed">
                    The **Colors** page shows the color resulting from combining E, P, I as R, G, B values. The **Bars** page shows the values in a bar chart. The **Today** page shows both views of a single day. The **Friends** page lets you save birthdays for easy access.
                </p>
                <p class="text-lg font-bold">Have fun!</p>
            </div>

        </div>
    </main>
    
    <!-- Placeholder for ad space -->
    <div id="ad-space" class="fixed bottom-0 left-0 right-0 h-16 bg-[#132238] border-t border-slate-700 flex items-center justify-center text-gray-400 text-sm">
        <p>Your Ad Space Here</p>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Biorhythm cycle lengths in days
        const PHYSICAL_CYCLE = 23;
        const EMOTIONAL_CYCLE = 28;
        const INTELLECTUAL_CYCLE = 33;

        // Global application state
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        let currentDate = new Date();
        let todayDate = new Date();
        let currentPageId = 'page1';
        let startWeekOnMonday = false;
        let currentBirthday = new Date(1951, 4, 22); // Default birthday
        let currentBirthdayName = "Me";
        let isAuthReady = false;
        let friends = [];
        let selectedFriendId = null;

        let db, auth;
        let friendsRef;
        
        // Asynchronous function to initialize Firebase and handle authentication
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const userId = user.uid;
                        console.log("Authenticated with user ID:", userId);
                        friendsRef = collection(db, `artifacts/${appId}/users/${userId}/friends`);
                        isAuthReady = true;
                        
                        // Listen for real-time updates to the friends collection
                        onSnapshot(friendsRef, (snapshot) => {
                            friends = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderFriendsList();
                            console.log("Friends list updated in real-time.");
                        }, (error) => {
                            console.error("Error listening to friends collection:", error);
                        });
                    } else {
                        console.log("Signed out.");
                        isAuthReady = false;
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // --- Biorhythm Calculation Functions ---
        const getDaysBetween = (date1, date2) => {
            const oneDay = 1000 * 60 * 60 * 24;
            const diffInTime = date2.getTime() - date1.getTime();
            return Math.floor(diffInTime / oneDay);
        };

        const calculateBiorhythms = (date, birthday) => {
            const daysSinceBirth = getDaysBetween(birthday, date);
            
            const physical = Math.sin((2 * Math.PI * daysSinceBirth) / PHYSICAL_CYCLE);
            const emotional = Math.sin((2 * Math.PI * daysSinceBirth) / EMOTIONAL_CYCLE);
            const intellectual = Math.sin((2 * Math.PI * daysSinceBirth) / INTELLECTUAL_CYCLE);
            
            return { physical, emotional, intellectual };
        };

        // --- Firestore Functions ---
        const addFriend = async (name, birthday) => {
            if (!name || !birthday) return;
            try {
                await addDoc(friendsRef, {
                    name,
                    birthday: birthday.toISOString(),
                });
                console.log("Friend added successfully!");
            } catch (e) {
                console.error("Error adding friend: ", e);
            }
        };

        const updateFriend = async (id, name, birthday) => {
            if (!id || !name || !birthday) return;
            try {
                const friendDoc = doc(db, friendsRef.path, id);
                await updateDoc(friendDoc, {
                    name,
                    birthday: birthday.toISOString(),
                });
                console.log("Friend updated successfully!");
            } catch (e) {
                console.error("Error updating friend: ", e);
            }
        };

        const deleteFriend = async (id) => {
            if (!id) return;
            try {
                const friendDoc = doc(db, friendsRef.path, id);
                await deleteDoc(friendDoc);
                console.log("Friend deleted successfully!");
            } catch (e) {
                console.error("Error deleting friend: ", e);
            }
        };
    
        // --- UI Rendering Functions ---
        const updateCurrentSubjectDisplay = () => {
            const subject = currentBirthdayName === "Me" ? "Your" : `${currentBirthdayName}'s`;
            document.getElementById('current-subject-display').textContent = `${subject} Biorhythms`;
        };
        
        const updateToggleButtonText = () => {
            const toggleButton = document.getElementById('week-start-toggle');
            toggleButton.textContent = startWeekOnMonday ? 'Begin week on Sunday' : 'Begin week on Monday';
        };

        const renderCalendar = () => {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            
            const weekdaysHeader = container.querySelector('.weekdays-header');
            const daysGrid = container.querySelector('.days-grid');
            weekdaysHeader.innerHTML = '';
            daysGrid.innerHTML = '';

            daysGrid.classList.add('days-grid-responsive');
            weekdaysHeader.classList.add('days-grid-responsive');
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            document.getElementById('month-select').value = month;
            document.getElementById('year-select').value = year;

            let firstDay = new Date(year, month, 1).getDay();
            if (startWeekOnMonday) {
                firstDay = (firstDay + 6) % 7;
            }

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

            let reorderedWeekdays = [...weekdayNames];
            if (startWeekOnMonday) {
                reorderedWeekdays = reorderedWeekdays.slice(1).concat(reorderedWeekdays[0]);
            }
            reorderedWeekdays.forEach(day => {
                const headerDiv = document.createElement('div');
                headerDiv.classList.add('text-lg', 'text-white');
                headerDiv.textContent = day;
                weekdaysHeader.appendChild(headerDiv);
            });

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('w-full', 'rounded', 'p-1', 'min-h-[5rem]');
                daysGrid.appendChild(emptyCell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell-responsive');
                const dayDate = new Date(year, month, i);
                const { physical, emotional, intellectual } = calculateBiorhythms(dayDate, currentBirthday);
                const classes = ['w-full', 'rounded', 'px-1', 'min-h-[5rem]', 'shadow-inner', 'relative', 'transition-colors', 'duration-200', 'cursor-pointer'];
                const dayNumberDiv = document.createElement('div');
                dayNumberDiv.classList.add('absolute', 'top-1', 'left-1', 'text-sm', 'sm:text-base', 'day-number-responsive');
                dayNumberDiv.textContent = i;
                
                dayCell.addEventListener('click', () => {
                    todayDate = dayDate;
                    showPage('page3');
                });
                
                if (currentPageId === 'page1') {
                    const r = Math.floor((emotional + 1) / 2 * 255);
                    const g = Math.floor((physical + 1) / 2 * 255);
                    const b = Math.floor((intellectual + 1) / 2 * 255);
                    
                    dayCell.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    let textColor = 'white';
                    if (luminance > 0.5) {
                        textColor = 'black';
                    }
                    dayNumberDiv.style.color = textColor;
                    
                    const scaledEmotional = Math.floor((emotional + 1) / 2 * 100);
                    const scaledPhysical = Math.floor((physical + 1) / 2 * 100);
                    const scaledIntellectual = Math.floor((intellectual + 1) / 2 * 100);

                    const labelDiv = document.createElement('div');
                    labelDiv.classList.add('absolute', 'top-1/2', '-translate-y-1/2', 'left-1', 'right-1', 'text-xs', 'flex', 'justify-between', 'space-x-1', 'day-labels-responsive');
                    labelDiv.style.color = textColor;
                    labelDiv.innerHTML = `<span class="whitespace-nowrap">E:${scaledEmotional}</span><span class="whitespace-nowrap">P:${scaledPhysical}</span><span class="whitespace-nowrap">I:${scaledIntellectual}</span>`;
                    
                    dayCell.appendChild(dayNumberDiv);
                    dayCell.appendChild(labelDiv);
                    classes.push('border');

                    const critMarkerContainer = document.createElement('div');
                    critMarkerContainer.classList.add('absolute', 'bottom-1', 'left-0', 'right-0', 'flex', 'justify-between', 'px-1', 'crit-marker-container-responsive');
                    
                    const markerE = document.createElement('div');
                    markerE.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
                    markerE.style.opacity = Math.abs(emotional) < 0.1 ? 1 : 0;
                    critMarkerContainer.appendChild(markerE);

                    const markerP = document.createElement('div');
                    markerP.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
                    markerP.style.opacity = Math.abs(physical) < 0.1 ? 1 : 0;
                    critMarkerContainer.appendChild(markerP);

                    const markerI = document.createElement('div');
                    markerI.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
                    markerI.style.opacity = Math.abs(intellectual) < 0.1 ? 1 : 0;
                    critMarkerContainer.appendChild(markerI);

                    dayCell.appendChild(critMarkerContainer);
                } else if (currentPageId === 'page2') {
                    dayCell.classList.add('border');
                    const scaledEmotional = Math.floor((emotional + 1) / 2 * 100);
                    const scaledPhysical = Math.floor((physical + 1) / 2 * 100);
                    const scaledIntellectual = Math.floor((intellectual + 1) / 2 * 100);

                    dayNumberDiv.classList.add('bg-black', 'bg-opacity-50', 'text-white', 'px-1', 'rounded-sm', 'z-10', 'day-number-responsive');
                    dayCell.appendChild(dayNumberDiv);

                    const barContainer = document.createElement('div');
                    barContainer.classList.add('absolute', 'bottom-0', 'left-0', 'right-0', 'h-full', 'flex', 'items-end', 'p-1', 'space-x-4');

                    const redBar = document.createElement('div');
                    redBar.classList.add('flex-1', 'bg-red-500', 'rounded-t-sm', 'border-t-2', 'border-white', 'relative');
                    redBar.style.height = `${scaledEmotional}%`;
                    if (Math.abs(emotional) < 0.1) {
                        const critMarker = document.createElement('div');
                        critMarker.classList.add('biorhythm-crit-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                        critMarker.style.top = '-22px';
                        redBar.appendChild(critMarker);
                    }
                    barContainer.appendChild(redBar);

                    const greenBar = document.createElement('div');
                    greenBar.classList.add('flex-1', 'bg-green-500', 'rounded-t-sm', 'border-t-2', 'border-white', 'relative');
                    greenBar.style.height = `${scaledPhysical}%`;
                    if (Math.abs(physical) < 0.1) {
                        const critMarker = document.createElement('div');
                        critMarker.classList.add('biorhythm-crit-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                        critMarker.style.top = '-22px';
                        greenBar.appendChild(critMarker);
                    }
                    barContainer.appendChild(greenBar);
                    
                    const blueBar = document.createElement('div');
                    blueBar.classList.add('flex-1', 'bg-blue-500', 'rounded-t-sm', 'border-t-2', 'border-white', 'relative');
                    blueBar.style.height = `${scaledIntellectual}%`;
                    if (Math.abs(intellectual) < 0.1) {
                        const critMarker = document.createElement('div');
                        critMarker.classList.add('biorhythm-crit-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                        critMarker.style.top = '-22px';
                        blueBar.appendChild(critMarker);
                    }
                    barContainer.appendChild(blueBar);
                    dayCell.appendChild(barContainer);
                }
                
                if (isCurrentMonth && i === today.getDate()) {
                    classes.push('border-4', 'border-white');
                }

                dayCell.classList.add(...classes);
                daysGrid.appendChild(dayCell);
            }
        };

        const renderTodayPage = () => {
            const displayGrid = document.getElementById('today-display-grid');
            displayGrid.innerHTML = '';
            
            const { physical, emotional, intellectual } = calculateBiorhythms(todayDate, currentBirthday);

            // --- Colors View ---
            const colorsDayCell = document.createElement('div');
            const r = Math.floor((emotional + 1) / 2 * 255);
            const g = Math.floor((physical + 1) / 2 * 255);
            const b = Math.floor((intellectual + 1) / 2 * 255);
            colorsDayCell.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            const textColor = luminance > 0.5 ? 'black' : 'white';
            
            colorsDayCell.classList.add('w-full', 'md:w-1/2', 'aspect-video', 'rounded-lg', 'border', 'shadow-inner', 'relative', 'transition-colors', 'duration-200', 'flex', 'flex-col', 'items-center', 'justify-center', 'p-4');
            
            const critLabelContainer = document.createElement('div');
            critLabelContainer.classList.add('absolute', 'top-1/2', 'left-1/2', '-translate-x-1/2', '-translate-y-1/2', 'flex', 'flex-col', 'items-center', 'space-y-1', 'z-20');
            
            const labelClasses = ['text-xl', 'sm:text-2xl', 'font-bold', 'text-center'];

            if (Math.abs(emotional) < 0.1) {
                const labelE = document.createElement('span');
                labelE.classList.add(...labelClasses);
                labelE.style.color = textColor;
                labelE.textContent = "Critical Emotional Day";
                critLabelContainer.appendChild(labelE);
            }
            if (Math.abs(physical) < 0.1) {
                const labelP = document.createElement('span');
                labelP.classList.add(...labelClasses);
                labelP.style.color = textColor;
                labelP.textContent = "Critical Physical Day";
                critLabelContainer.appendChild(labelP);
            }
            if (Math.abs(intellectual) < 0.1) {
                const labelI = document.createElement('span');
                labelI.classList.add(...labelClasses);
                labelI.style.color = textColor;
                labelI.textContent = "Critical Intellectual Day";
                critLabelContainer.appendChild(labelI);
            }
            colorsDayCell.appendChild(critLabelContainer);

            const critMarkerContainerColors = document.createElement('div');
            critMarkerContainerColors.classList.add('absolute', 'bottom-4', 'left-0', 'right-0', 'flex', 'justify-around', 'px-1');
            
            const markerEColors = document.createElement('div');
            markerEColors.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
            markerEColors.style.opacity = Math.abs(emotional) < 0.1 ? 1 : 0;
            critMarkerContainerColors.appendChild(markerEColors);

            const markerPColors = document.createElement('div');
            markerPColors.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
            markerPColors.style.opacity = Math.abs(physical) < 0.1 ? 1 : 0;
            critMarkerContainerColors.appendChild(markerPColors);

            const markerIColors = document.createElement('div');
            markerIColors.classList.add('biorhythm-crit-marker', 'black-outlined-marker');
            markerIColors.style.opacity = Math.abs(intellectual) < 0.1 ? 1 : 0;
            critMarkerContainerColors.appendChild(markerIColors);

            colorsDayCell.appendChild(critMarkerContainerColors);
            displayGrid.appendChild(colorsDayCell);


            // --- Bars View ---
            const barsDayCell = document.createElement('div');
            barsDayCell.classList.add('w-full', 'md:w-1/2', 'aspect-video', 'rounded-lg', 'border', 'shadow-inner', 'relative', 'transition-colors', 'duration-200', 'flex', 'flex-col', 'items-center', 'justify-center', 'p-4', 'bg-[#132238]');

            const scaledEmotionalBars = Math.floor((emotional + 1) / 2 * 100);
            const scaledPhysicalBars = Math.floor((physical + 1) / 2 * 100);
            const scaledIntellectualBars = Math.floor((intellectual + 1) / 2 * 100);

            const barContainer = document.createElement('div');
            barContainer.classList.add('w-full', 'h-full', 'flex', 'items-end', 'p-2', 'space-x-4', 'justify-center');

            const redBar = document.createElement('div');
            redBar.classList.add('flex-1', 'bg-red-500', 'rounded-t-lg', 'border-t-2', 'border-white', 'relative');
            redBar.style.height = `${scaledEmotionalBars}%`;
            const redLabel = document.createElement('span');
            redLabel.classList.add('absolute', '-top-6', 'text-sm', 'md:text-base', 'font-bold', 'w-full', 'text-center');
            redLabel.textContent = `E:${scaledEmotionalBars}`;
            redBar.appendChild(redLabel);
            if (Math.abs(emotional) < 0.1) {
                const critMarker = document.createElement('div');
                critMarker.classList.add('biorhythm-crit-marker', 'black-outlined-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                critMarker.style.top = '2px';
                redBar.appendChild(critMarker);
            }
            barContainer.appendChild(redBar);

            const greenBar = document.createElement('div');
            greenBar.classList.add('flex-1', 'bg-green-500', 'rounded-t-lg', 'border-t-2', 'border-white', 'relative');
            greenBar.style.height = `${scaledPhysicalBars}%`;
            const greenLabel = document.createElement('span');
            greenLabel.classList.add('absolute', '-top-6', 'text-sm', 'md:text-base', 'font-bold', 'w-full', 'text-center');
            greenLabel.textContent = `P:${scaledPhysicalBars}`;
            greenBar.appendChild(greenLabel);
            if (Math.abs(physical) < 0.1) {
                const critMarker = document.createElement('div');
                critMarker.classList.add('biorhythm-crit-marker', 'black-outlined-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                critMarker.style.top = '2px';
                greenBar.appendChild(critMarker);
            }
            barContainer.appendChild(greenBar);
            
            const blueBar = document.createElement('div');
            blueBar.classList.add('flex-1', 'bg-blue-500', 'rounded-t-lg', 'border-t-2', 'border-white', 'relative');
            blueBar.style.height = `${scaledIntellectualBars}%`;
            const blueLabel = document.createElement('span');
            blueLabel.classList.add('absolute', '-top-6', 'text-sm', 'md:text-base', 'font-bold', 'w-full', 'text-center');
            blueLabel.textContent = `I:${scaledIntellectualBars}`;
            blueBar.appendChild(blueLabel);
            if (Math.abs(intellectual) < 0.1) {
                const critMarker = document.createElement('div');
                critMarker.classList.add('biorhythm-crit-marker', 'black-outlined-marker', 'absolute', 'left-1/2', '-translate-x-1/2');
                critMarker.style.top = '2px';
                blueBar.appendChild(critMarker);
            }
            barContainer.appendChild(blueBar);

            barsDayCell.appendChild(barContainer);
            displayGrid.appendChild(barsDayCell);
        };
        
        // Renders the list of friends from the Firestore data
        const renderFriendsList = () => {
            const friendsListContainer = document.getElementById('friends-list');
            const loadingIndicator = document.getElementById('loading-friends');
            
            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }

            friendsListContainer.innerHTML = '';
            
            if (friends.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-center text-gray-400">No friends added yet. Use the form below to add one!</p>';
            }

            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                const friendBirthday = new Date(friend.birthday);
                friendItem.classList.add('flex', 'items-center', 'justify-between', 'bg-[#2a4365]', 'rounded-md', 'p-3', 'cursor-pointer', 'hover:bg-[#345388]', 'transition-colors', 'duration-200');
                friendItem.innerHTML = `
                    <span class="text-lg font-semibold">${friend.name}</span>
                    <span class="text-sm text-gray-300">
                        (${monthNames[friendBirthday.getMonth()]} ${friendBirthday.getDate()}, ${friendBirthday.getFullYear()})
                    </span>
                    <div>
                        <button class="edit-btn text-yellow-400 hover:text-yellow-300 transition-colors duration-200 ml-2" data-id="${friend.id}">Edit</button>
                        <button class="delete-btn text-red-400 hover:text-red-300 transition-colors duration-200 ml-2" data-id="${friend.id}">Delete</button>
                    </div>
                `;
                friendItem.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') {
                        selectFriend(friend.id);
                    }
                });

                friendsListContainer.appendChild(friendItem);
            });

            // Attach event listeners to new buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const friendId = e.target.dataset.id;
                    const friendToEdit = friends.find(f => f.id === friendId);
                    if (friendToEdit) {
                        const friendBirthday = new Date(friendToEdit.birthday);
                        document.getElementById('friend-name').value = friendToEdit.name;
                        document.getElementById('friend-month-select').value = friendBirthday.getMonth();
                        updateFriendDays(friendBirthday.getMonth(), friendBirthday.getFullYear(), friendBirthday.getDate());
                        document.getElementById('friend-year-select').value = friendBirthday.getFullYear();
                        document.getElementById('add-friend-form').dataset.editId = friendToEdit.id;
                        document.getElementById('add-friend-form').querySelector('button[type="submit"]').textContent = 'Update Friend';
                        document.getElementById('cancel-edit-btn').classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const friendId = e.target.dataset.id;
                    deleteFriend(friendId);
                });
            });
        };

        const selectFriend = (friendId) => {
            selectedFriendId = friendId;
            const friend = friends.find(f => f.id === friendId);
            if (friend) {
                currentBirthday = new Date(friend.birthday);
                currentBirthdayName = friend.name;
            } else {
                currentBirthday = new Date(1951, 4, 22);
                currentBirthdayName = "Me";
            }
            updateCurrentSubjectDisplay();
            showPage('page1');
        };

        const resetFriendForm = () => {
            const form = document.getElementById('add-friend-form');
            form.reset();
            delete form.dataset.editId;
            form.querySelector('button[type="submit"]').textContent = 'Add Friend';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            populateFriendSelectors(currentBirthday);
        };

        // --- Main Page Logic ---
        const showPage = (pageId) => {
            currentPageId = pageId;
            const pageContents = document.querySelectorAll('.page-content');
            const navButtons = document.querySelectorAll('.nav-button');
            const monthYearSelectors = document.getElementById('month-year-selectors');
            const weekStartToggle = document.getElementById('week-start-toggle');
            const criticalDayLabel = document.getElementById('critical-day-label');

            pageContents.forEach(page => page.classList.add('hidden'));
            navButtons.forEach(button => button.classList.remove('active-nav-button'));

            const activeNavButton = document.getElementById(`nav-${pageId.slice(4).toLowerCase()}`);
            if (activeNavButton) {
                activeNavButton.classList.add('active-nav-button');
            }

            // Show/hide controls based on the page
            monthYearSelectors.classList.add('hidden');
            weekStartToggle.classList.add('hidden');
            criticalDayLabel.classList.add('hidden');
            
            if (pageId === 'page1' || pageId === 'page2') {
                document.getElementById('calendar-container').classList.remove('hidden');
                monthYearSelectors.classList.remove('hidden');
                weekStartToggle.classList.remove('hidden');
                criticalDayLabel.classList.remove('hidden');
                renderCalendar();
            } else if (pageId === 'page3') {
                document.getElementById('page3-content').classList.remove('hidden');
                criticalDayLabel.classList.remove('hidden');
                updateTodaySelectorsFromDate();
            } else if (pageId === 'page4') {
                document.getElementById('page4-content').classList.remove('hidden');
            } else if (pageId === 'page5') {
                document.getElementById('page5-content').classList.remove('hidden');
                resetFriendForm();
            }
        };
        
        // Handles changing the month with arrows
        const changeMonth = (direction) => {
            if (direction === 'prev') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            renderCalendar();
        };

        // Handles changing the month and year with selectors
        const updateCalendarFromSelects = () => {
            const month = document.getElementById('month-select').value;
            const year = document.getElementById('year-select').value;
            currentDate.setMonth(month);
            currentDate.setFullYear(year);
            renderCalendar();
        };

        // Handles changing the day with arrows on the "Today" page
        const changeDay = (direction) => {
            if (direction === 'prev') {
                todayDate.setDate(todayDate.getDate() - 1);
            } else {
                todayDate.setDate(todayDate.getDate() + 1);
            }
            updateTodaySelectorsFromDate();
        };

        // Updates the "Today" page selectors and text to match the todayDate
        const updateTodaySelectorsFromDate = () => {
            document.getElementById('today-month-select').value = todayDate.getMonth();
            document.getElementById('today-day-select').value = todayDate.getDate();
            document.getElementById('today-year-select').value = todayDate.getFullYear();
            updateTodayDateText();
            renderTodayPage();
        };

        // Handles changing the date on the "Today" page selectors
        const updateTodayFromSelects = () => {
            const month = document.getElementById('today-month-select').value;
            const day = document.getElementById('today-day-select').value;
            const year = document.getElementById('today-year-select').value;
            todayDate.setMonth(month);
            todayDate.setFullYear(year);
            todayDate.setDate(day);
            updateTodayDateText();
            renderTodayPage();
        };

        // Updates the text display with the full formatted date
        const updateTodayDateText = () => {
            const dayOfWeek = weekdayNames[todayDate.getDay()];
            const month = monthNames[todayDate.getMonth()];
            const day = todayDate.getDate();
            const year = todayDate.getFullYear();
            const dateString = `${dayOfWeek}, ${month} ${day}, ${year}`;
            document.getElementById('today-date-text').textContent = dateString;
        };

        const toggleWeekStart = () => {
            startWeekOnMonday = !startWeekOnMonday;
            localStorage.setItem('startWeekOnMonday', startWeekOnMonday);
            updateToggleButtonText();
            renderCalendar();
        };

        const populateSelectors = () => {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            monthSelect.innerHTML = '';
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let i = currentYear - 50; i <= currentYear + 50; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
        };

        const populateTodaySelectors = () => {
            const monthSelect = document.getElementById('today-month-select');
            const daySelect = document.getElementById('today-day-select');
            const yearSelect = document.getElementById('today-year-select');
            monthSelect.innerHTML = '';
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let i = currentYear - 50; i <= currentYear + 50; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            updateTodayDays();
        };

        const updateTodayDays = () => {
            const monthSelect = document.getElementById('today-month-select');
            const daySelect = document.getElementById('today-day-select');
            const yearSelect = document.getElementById('today-year-select');
            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            daySelect.innerHTML = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                daySelect.appendChild(option);
            }
            const currentDay = todayDate.getDate();
            if (currentDay <= daysInMonth) {
                daySelect.value = currentDay;
            } else {
                daySelect.value = 1;
            }
        };

        const populateFriendSelectors = (date = new Date()) => {
            const monthSelect = document.getElementById('friend-month-select');
            const daySelect = document.getElementById('friend-day-select');
            const yearSelect = document.getElementById('friend-year-select');
            const currentYear = new Date().getFullYear();
            
            monthSelect.innerHTML = '';
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            yearSelect.innerHTML = '';
            for (let i = currentYear - 100; i <= currentYear; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            
            monthSelect.value = date.getMonth();
            yearSelect.value = date.getFullYear();
            updateFriendDays(date.getMonth(), date.getFullYear(), date.getDate());
        };

        const updateFriendDays = (selectedMonth, selectedYear, selectedDay) => {
            const daySelect = document.getElementById('friend-day-select');
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            daySelect.innerHTML = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                daySelect.appendChild(option);
            }
            if (selectedDay <= daysInMonth) {
                daySelect.value = selectedDay;
            } else {
                daySelect.value = 1;
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const savedWeekStart = localStorage.getItem('startWeekOnMonday');
            if (savedWeekStart !== null) {
                startWeekOnMonday = savedWeekStart === 'true';
            }
            updateToggleButtonText();
            updateCurrentSubjectDisplay();
            populateSelectors();
            populateTodaySelectors();
            populateFriendSelectors(currentBirthday);

            await initializeFirebase();
            showPage('page1');

            document.getElementById('add-friend-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const name = form['friend-name'].value;
                const month = parseInt(form['friend-month-select'].value);
                const day = parseInt(form['friend-day-select'].value);
                const year = parseInt(form['friend-year-select'].value);
                const bday = new Date(year, month, day);

                const editId = form.dataset.editId;

                if (editId) {
                    await updateFriend(editId, name, bday);
                } else {
                    await addFriend(name, bday);
                }
                resetFriendForm();
            });

            document.getElementById('friend-month-select').addEventListener('change', () => {
                const month = parseInt(document.getElementById('friend-month-select').value);
                const year = parseInt(document.getElementById('friend-year-select').value);
                const day = parseInt(document.getElementById('friend-day-select').value);
                updateFriendDays(month, year, day);
            });

            document.getElementById('friend-year-select').addEventListener('change', () => {
                const month = parseInt(document.getElementById('friend-month-select').value);
                const year = parseInt(document.getElementById('friend-year-select').value);
                const day = parseInt(document.getElementById('friend-day-select').value);
                updateFriendDays(month, year, day);
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', resetFriendForm);

            // Add event listeners for navigation buttons
            document.getElementById('nav-colors').addEventListener('click', () => showPage('page1'));
            document.getElementById('nav-bars').addEventListener('click', () => showPage('page2'));
            document.getElementById('nav-today').addEventListener('click', () => {
                todayDate = new Date();
                showPage('page3');
            });
            document.getElementById('nav-friends').addEventListener('click', () => showPage('page5'));
            document.getElementById('nav-help').addEventListener('click', () => showPage('page4'));
            
            // Add event listeners for month/year selectors and arrows
            document.getElementById('month-select').addEventListener('change', updateCalendarFromSelects);
            document.getElementById('year-select').addEventListener('change', updateCalendarFromSelects);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth('prev'));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth('next'));
            document.getElementById('week-start-toggle').addEventListener('click', toggleWeekStart);

            // Add event listeners for today date selectors and arrows
            document.getElementById('today-month-select').addEventListener('change', () => {
                updateTodayDays();
                updateTodayFromSelects();
            });
            document.getElementById('today-day-select').addEventListener('change', updateTodayFromSelects);
            document.getElementById('today-year-select').addEventListener('change', () => {
                updateTodayDays();
                updateTodayFromSelects();
            });
            document.getElementById('prev-day-btn').addEventListener('click', () => changeDay('prev'));
            document.getElementById('next-day-btn').addEventListener('click', () => changeDay('next'));
        });
    </script>
</body>
</html>


